var mindb=function(){"use strict";function e(e,t){t=t.replace(/\[(\w+)\]/g,".$1"),t=t.replace(/^\./,"");var n=t.split("."),i=e;return n.forEach(function(e){if(!i.hasOwnProperty(e))throw new Error("Nested property '"+t+"' could not be resolved at '"+e+"' property.");i=i[e]}),i}function t(e,t,i){switch(i){case"insertion":return void o(e,t);case"heap":return void s(e,t);case"native":return void n(e,t);case"quick":return void u(e,t);default:return void n(e,t)}}function n(e,t){e.sort(r(t))}function i(t){return function(n,i){for(var r=t.length,o=0;o<r;++o){var s=t[o],a=void 0,u=void 0;if(s.nested?(a=e(n,s.key),u=e(i,s.key)):(a=n[s.key],u=i[s.key]),a!==u)return(a>u?1:-1)*s.order}return 0}}function r(e){var t="";return e.forEach(function(e){t+="if(a."+e.key+(1===e.order?">":"<")+"b."+e.key+")return 1;",t+="if(a."+e.key+(1===e.order?"<":">")+"b."+e.key+")return -1;"}),t+="return 0;",Function("a","b",t)}function o(e,t){for(var n=r(t),i=1;i<e.length;++i)for(var o=i;o>0&&n(e[o-1],e[o])>0;)f(e,o,o-1),o--}function s(e,t){for(var n=r(t),i=e.length,o=Math.floor(.5*i);o>-1;--o)a(e,o,i,n);for(var s=e.length-1;s>0;--s)f(e,0,s),i--,a(e,0,i,n)}function a(e,t,n,i){var r=2*t+1,o=2*t+2,s=t;r<n&&i(e[r],e[s])>0&&(s=r),o<n&&i(e[o],e[s])>0&&(s=o),s!==t&&(f(e,t,s),a(e,s,n,i))}function u(e,t){c(e,0,e.length-1,r(t))}function c(e,t,n,i){for(var r=t,o=n,s=!0,a=n;t-n<0;)s?i(e[a],e[t])<0?(f(e,a,t),a=t,n--,s=!s):t++:i(e[a],e[n])<=0?n--:(f(e,a,n),a=n,t++,s=!s);a-1>r&&c(e,r,a-1,i),a+1<o&&c(e,a+1,o,i)}function f(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function l(e){var t=[];return e.forEach(function(e){var n="-"===e[0]?-1:1,i=!!e.match(/(\[|\]|\.)/g);t.push({key:e.replace(/(\-|\+)/g,""),order:n,nested:i})}),t}function h(e,t,n,r){for(var o=i(n),s=0,a=e.length-1,u=void 0,c=void 0;;){if(u=s+Math.floor((a-s)/2),0===(c=o(t,e[u])))return u;if(c>0){if(u===a)return r?u+1:-1;s+=Math.ceil((a-s+1)/2)}else{if(u===s)return r?u:-1;a-=Math.ceil((a-s+1)/2)}}}function d(e,t,n){var i=new b(e,t,n);return new Proxy(i,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Collection.")}})}function v(e,t){var n=new g(e,t);return new Proxy(n,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Database.")}})}var y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},m=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),w=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},p=function(){function e(n,i,r){_(this,e),this._collection=n,this.name=i,this._index=this._collection.values()||[],this._sortData=r,this._index.length>1&&this._sortData&&t(this._index,this._sortData)}return m(e,[{key:"empty",value:function(){this._index.length=0}},{key:"insert",value:function(e){if(this._sortData&&this._index.length>0){var t=h(this._index,e,this._sortData,!0);this._index.splice(t,0,e)}else this._index.push(e)}},{key:"remove",value:function(e){if(this._sortData){var t=h(this._index,e,this._sortData);this._index.splice(t,1)}else this._index.splice(this._index.findIndex(function(t){return t._id===e._id}),1)}},{key:"values",value:function(){return this._index.slice()}}]),e}(),E=require("clone"),k=function(){function e(t,n){_(this,e),this._collection=t,this._data=n||{}}return m(e,[{key:"byId",value:function(t){var n=E(this._data,!1);return n.byId=t,new e(this._collection,n)}},{key:"count",value:function(){var t=E(this._data,!1);return t.count=!0,new e(this._collection,t)}},{key:"eq",value:function(e){return this.op("===",e)}},{key:"exec",value:function(){var e=this._data,n=void 0,i=void 0,r=!1;if(e.byId)n=[this._collection.get(e.byId)];else{if(e.sort){var o=e.sort.slice();for(r=!0;o.length>0||void 0===n;){var s=o.map(function(e){return(-1===e.order?"-":"")+e.key}).join(","),a=o.map(function(e){return(-1===e.order?"":"-")+e.key}).join(",");if(n=this._collection.values(s)){i=s;break}if(n=this._collection.values(a)){i=a,n=n.reverse();break}r=!1,o.pop()}}n||(n=this._collection.values()),e.filters&&e.filters.forEach(function(e){n=n.filter(e)}),e.wheres&&e.wheres.forEach(function(e){n=n.filter(function(t){switch(e.op){case">":return t[e.key]>e.value;case"<":return t[e.key]<e.value;case">=":return t[e.key]>=e.value;case"<=":return t[e.key]<=e.value;case"===":return t[e.key]===e.value;case"!==":return t[e.key]!==e.value}})}),!e.sort||e.count||i&&r||(i&&!r?t(n,e.sort,"insertion"):t(n,e.sort,"native")),(e.limit||e.offset)&&(n=n.slice(e.offset||0,(e.offset||0)+(e.limit||n.length)))}return e.select&&(n=n.map(function(t){var n={_id:t._id};return e.select.forEach(function(e){return n[e]=t[e]}),n})),e.count?n.length:1===e.limit||e.byId?n[0]:n}},{key:"exists",value:function(){return this.op("!==",void 0)}},{key:"filter",value:function(t){var n=E(this._data,!1);return n.filters=n.filters||[],n.filters.push(t),new e(this._collection,n)}},{key:"gt",value:function(e){return this.op(">",e)}},{key:"gte",value:function(e){return this.op(">=",e)}},{key:"is",value:function(e){return this.eq(e)}},{key:"limit",value:function(t){var n=E(this._data,!1);return n.limit=t,new e(this._collection,n)}},{key:"lt",value:function(e){return this.op("<",e)}},{key:"lte",value:function(e){return this.op("<=",e)}},{key:"ne",value:function(e){return this.op("!==",e)}},{key:"neg",value:function(){return this.op("<",0)}},{key:"negative",value:function(){return this.neg()}},{key:"not",value:function(e){return this.ne(e)}},{key:"offset",value:function(t){var n=E(this._data,!1);return n.offset=t,new e(this._collection,n)}},{key:"one",value:function(){return this.limit(1)}},{key:"op",value:function(t,n){var i=E(this._data,!1);return i.wheres=i.wheres||[],i.wheres.push({key:i.key,value:n,op:t}),new e(this._collection,i)}},{key:"populate",value:function(){if(!this._collection.schema)throw new Error("Cannot populate document without a defined schema for '"+this._collection.schema+"'.");for(var t=E(this._data,!1),n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return t.populate=i,new e(this._collection,t)}},{key:"pos",value:function(){return this.op(">",0)}},{key:"positive",value:function(){return this.pos()}},{key:"select",value:function(){for(var t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];if(-1!==n.indexOf("_id"))throw new Error("Document id is always included in the Document, no need to explicity select it.");if(!n.every(function(e){return"string"==typeof e}))throw new Error('All select keys must be of type "string".');var r=E(this._data,!1);return r.select=n,new e(this._collection,r)}},{key:"sort",value:function(){for(var t=E(this._data,!1),n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return t.sort=l(i),new e(this._collection,t)}},{key:"within",value:function(e,t){return this.op(">=",e).op("<=",t)}},{key:"where",value:function(t){var n=E(this._data,!1);return n.action="where",n.key=t,new e(this._collection,n)}}]),e}(),b=function(){function e(t,n,i){_(this,e),this._database=t,this.name=n,this.schema=i,this._documents={},this._indexes=w({},e._DEFAULT_INDEX,new p(this,e._DEFAULT_INDEX))}return m(e,[{key:"count",value:function(){return this.find().count()}},{key:"empty",value:function(){var e=this;this._documents={},Object.keys(this._indexes).forEach(function(t){e._indexes[t].empty()})}},{key:"find",value:function(){return new k(this)}},{key:"findOne",value:function(e){if(e&&"string"!=typeof e)throw new Error('The document is must be a "string", not a "'+(void 0===e?"undefined":y(e))+'".');return e?this.find().byId(e):this.find().limit(1)}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The document id must be a "string", not a "'+("undefined"==typeof name?"undefined":y(name))+'".');if(e in this._documents)return this._documents[e]}},{key:"index",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=l(t),r=t.map(function(e){return e.replace(/^\+/,"")}).join(",");this._indexes[r]=new p(this,r,i)}},{key:"insert",value:function(t){var n=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t._id)throw new Error("The document to be inserted has no '_id'.");if("string"!=typeof t._id)throw new Error('A document must have a "string" _id, not a "'+("undefined"==typeof name?"undefined":y(name))+'".');if(e._RESERVED.forEach(function(e){if(t._id===e)throw new Error("The document _id '"+t._id+"' is an internal reserved name and cannot be used.")}),t._id in this._documents){if(!i)throw new Error("The document _id '"+t._id+"' already exists within the '"+this.name+"' collection.");this.remove(t)}return this._documents[t._id]=t,Object.keys(this._indexes).forEach(function(e){n._indexes[e].insert(t)}),t}},{key:"list",value:function(){return Object.keys(this._documents)}},{key:"remove",value:function(e){var t=this;if(!e)throw new Error("No argument provided to remove from collection.");if(Array.isArray(e))e.forEach(function(e){t.remove(e)});else if("object"===(void 0===e?"undefined":y(e))){if(!("_id"in e))throw new Error("The provided document to remove has no '_id'.");if("string"!=typeof e._id)throw new Error("The provided document to remove has a non-string '_id'.");delete this._documents[e._id],Object.keys(this._indexes).forEach(function(n){t._indexes[n].remove(e)})}else{if("string"!=typeof e)throw new Error('Incorrect argument provided to remove, must be either "string", "Document" or "Document[]", not "'+(void 0===e?"undefined":y(e))+'".');var n=this.get(e);n&&this.remove(n)}}},{key:"upsert",value:function(e){return this.insert(e,!0)}},{key:"values",value:function(t){if(!t){if(!(this._indexes&&e._DEFAULT_INDEX in this._indexes))return;return this._indexes[e._DEFAULT_INDEX].values()}if(t in this._indexes)return this._indexes[t].values()}}]),e}();b._DEFAULT_INDEX="__default",b._RESERVED=["_DEFAULT_INDEX","_RESERVED","name","schema","_database","_documents","_indexes","get","insert","list","upsert","values"];var g=function(){function e(t,n){_(this,e),this.name=t,this._collections={},this._options=n}return m(e,[{key:"collection",value:function(t,n){if("string"!=typeof t)throw new Error('The collection name must be a "string", not "'+(void 0===t?"undefined":y(t))+'".');if(e._RESERVED.forEach(function(e){if(t===e)throw new Error("Collection name '"+t+"' is an internal reserved name and cannot be used.")}),t in this._collections)throw new Error("A collection with name '"+t+"' already exists on database '"+this.name+"'.");var i=d(this,t,n);return this._collections[t]=i,i}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The collection name must be a "string", "not a "'+(void 0===e?"undefined":y(e))+'".');if(e in this._collections)return this._collections[e];throw new Error("Collection name '"+e+"' has not been created and does not exist on database '"+this.name+"'.")}},{key:"list",value:function(){return Object.keys(this._collections)}}]),e}();g._RESERVED=["_RESERVED","name","_collections","_options","collection","get","list"];var x=function(){function e(){_(this,e),this.Database=g,this.Collection=b,this.Index=p,this.Query=k,this._databases={}}return m(e,[{key:"create",value:function(t){if("string"!=typeof t)throw new Error('The database name must be a "string", not "'+(void 0===t?"undefined":y(t))+'".');if(e._RESERVED.forEach(function(e){if(t===e)throw new Error("Database name '"+t+"' is an internal reserved name and cannot be used.")}),t in this._databases)throw new Error("A database with name '"+t+"' already exists.");var n=v(t);return this._databases[t]=n,n}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":y(e))+'".');if(e in this._databases)return this._databases[e];throw new Error("Database name '"+e+"' has not been created and does not exist.")}},{key:"list",value:function(){return Object.keys(this._databases)}},{key:"reset",value:function(e){if(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":y(e))+'".');if(!(e in this._databases))throw new Error("Database name '"+e+"' does not exist and cannot be reset.");delete this._databases[e]}else this._databases={}}}]),e}();return x._RESERVED=["Database","Collection","Query","_RESERVED","_databases","create","get","list","reset"],new Proxy(new x,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.")}})}();
