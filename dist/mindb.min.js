var mindb=function(){"use strict";function e(e,t){t=t.replace(/\[(\w+)\]/g,".$1"),t=t.replace(/^\./,"");var n=t.split("."),i=e;return n.forEach(function(e){if(!i.hasOwnProperty(e))throw new Error("Nested property '"+t+"' could not be resolved at '"+e+"' property.");i=i[e]}),i}function t(t,n,i){for(var r=t.length,o=0;o<r;++o){var a=t[o],s=void 0,u=void 0;if(a.nested?(s=e(n,a.key),u=e(i,a.key)):(s=n[a.key],u=i[a.key]),s!==u)return(s>u?1:-1)*a.order}return 0}function n(e,t){i(e,0,e.length-1,t)}function i(e,n,o,a){for(var s=n,u=o,c=!0,l=o;n-o<0;)c?t(a,e[l],e[n])<0?(r(e,l,n),l=n,o--,c=!c):n++:t(a,e[l],e[o])<=0?o--:(r(e,l,o),l=o,n++,c=!c);l-1>s&&i(e,s,l-1,a),l+1<u&&i(e,l+1,u,a)}function r(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function o(e,t,n){var i=new y(e,t,n);return new Proxy(i,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Collection.")}})}function a(e,t){var n=new v(e,t);return new Proxy(n,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Database.")}})}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},f=function(){function e(t,n){u(this,e),this.name=t,this._index=[],this._sortData=n}return c(e,[{key:"empty",value:function(){this._index.length=0}},{key:"insert",value:function(e){this._sortData||this._index.push(e)}},{key:"remove",value:function(e){this._sortData||this._index.splice(this._index.findIndex(function(t){return t._id===e._id}),1)}},{key:"values",value:function(){return this._index}}]),e}(),h=require("clone"),d=function(){function e(t,n){u(this,e),this._collection=t,this._data=n||{}}return c(e,[{key:"byId",value:function(t){var n=h(this._data,!1);return n.byId=t,new e(this._collection,n)}},{key:"count",value:function(){var t=h(this._data,!1);return t.count=!0,new e(this._collection,t)}},{key:"eq",value:function(e){return this.op("===",e)}},{key:"exec",value:function(){var e=this._data,t=void 0;return e.byId?t=[this._collection.get(e.byId)]:(t=this._collection.values(),e.filters&&e.filters.forEach(function(e){t=t.filter(e)}),e.wheres&&e.wheres.forEach(function(e){t=t.filter(function(t){switch(e.op){case">":return t[e.key]>e.value;case"<":return t[e.key]<e.value;case">=":return t[e.key]>=e.value;case"<=":return t[e.key]<=e.value;case"===":return t[e.key]===e.value;case"!==":return t[e.key]!==e.value}})}),e.sort&&!e.count&&n(t,e.sort),(e.limit||e.offset)&&(t=t.slice(e.offset||0,(e.offset||0)+(e.limit||t.length)))),e.select&&(t=t.map(function(t){var n={_id:t._id};return e.select.forEach(function(e){return n[e]=t[e]}),n})),e.count?t.length:1===e.limit||e.byId?t[0]:t}},{key:"exists",value:function(){return this.op("!==",void 0)}},{key:"filter",value:function(t){var n=h(this._data,!1);return n.filters=n.filters||[],n.filters.push(t),new e(this._collection,n)}},{key:"gt",value:function(e){return this.op(">",e)}},{key:"gte",value:function(e){return this.op(">=",e)}},{key:"is",value:function(e){return this.eq(e)}},{key:"limit",value:function(t){var n=h(this._data,!1);return n.limit=t,new e(this._collection,n)}},{key:"lt",value:function(e){return this.op("<",e)}},{key:"lte",value:function(e){return this.op("<=",e)}},{key:"ne",value:function(e){return this.op("!==",e)}},{key:"neg",value:function(){return this.op("<",0)}},{key:"negative",value:function(){return this.neg()}},{key:"not",value:function(e){return this.ne(e)}},{key:"offset",value:function(t){var n=h(this._data,!1);return n.offset=t,new e(this._collection,n)}},{key:"one",value:function(){return this.limit(1)}},{key:"op",value:function(t,n){var i=h(this._data,!1);return i.wheres=i.wheres||[],i.wheres.push({key:i.key,value:n,op:t}),new e(this._collection,i)}},{key:"populate",value:function(){if(!this._collection.schema)throw new Error("Cannot populate document without a defined schema for '"+this._collection.schema+"'.");for(var t=h(this._data,!1),n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return t.populate=i,new e(this._collection,t)}},{key:"pos",value:function(){return this.op(">",0)}},{key:"positive",value:function(){return this.pos()}},{key:"select",value:function(){for(var t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];if(-1!==n.indexOf("_id"))throw new Error("Document id is always included in the Document, no need to explicity select it.");if(!n.every(function(e){return"string"==typeof e}))throw new Error('All select keys must be of type "string".');var r=h(this._data,!1);return r.select=n,new e(this._collection,r)}},{key:"sort",value:function(){var t=h(this._data,!1);t.sort=[];for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return i.forEach(function(e){var n="-"===e[0]?-1:1,i=!!e.match(/(\[|\]|\.)/g);t.sort.push({key:e.replace(/(\-|\+)/g,""),order:n,nested:i})}),new e(this._collection,t)}},{key:"within",value:function(e,t){return this.op(">=",e).op("<=",t)}},{key:"where",value:function(t){var n=h(this._data,!1);return n.action="where",n.key=t,new e(this._collection,n)}}]),e}(),y=function(){function e(t,n,i){u(this,e),this._database=t,this.name=n,this.schema=i,this._documents={},this._indexes=l({},e._DEFAULT_INDEX,new f(e._DEFAULT_INDEX))}return c(e,[{key:"empty",value:function(){this._documents={},this._indexes[e._DEFAULT_INDEX].empty()}},{key:"find",value:function(){return new d(this)}},{key:"findOne",value:function(e){if(e&&"string"!=typeof e)throw new Error('The document is must be a "string", not a "'+(void 0===e?"undefined":s(e))+'".');return e?this.find().byId(e):this.find().limit(1)}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The document id must be a "string", not a "'+("undefined"==typeof name?"undefined":s(name))+'".');if(e in this._documents)return this._documents[e]}},{key:"insert",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t._id)throw new Error("The document to be inserted has no '_id'.");if("string"!=typeof t._id)throw new Error('A document must have a "string" _id, not a "'+("undefined"==typeof name?"undefined":s(name))+'".');if(e._RESERVED.forEach(function(e){if(t._id===e)throw new Error("The document _id '"+t._id+"' is an internal reserved name and cannot be used.")}),!n&&t._id in this._documents)throw new Error("The document _id '"+t._id+"' already exists within the '"+this.name+"' collection.");return this._documents[t._id]=t,this._indexes[e._DEFAULT_INDEX].insert(t),t}},{key:"list",value:function(){return Object.keys(this._documents)}},{key:"remove",value:function(t){var n=this;if(!t)throw new Error("No argument provided to remove from collection.");if(Array.isArray(t))t.forEach(function(e){n.remove(e)});else if("object"===(void 0===t?"undefined":s(t))&&"_id"in t)delete this._documents[t._id],this._indexes[e._DEFAULT_INDEX].remove(t);else{if("string"!=typeof t)throw new Error('Incorrect argument provided to remove, must be either "string", "Document" or "Document[]", not "'+(void 0===t?"undefined":s(t))+'".');var i=this.get(t);i&&this.remove(i)}}},{key:"upsert",value:function(e){return this.insert(e,!0)}},{key:"values",value:function(){return this._indexes[e._DEFAULT_INDEX].values()}}]),e}();y._DEFAULT_INDEX="__default",y._RESERVED=["_DEFAULT_INDEX","_RESERVED","name","schema","_database","_documents","_indexes","get","insert","list","upsert","values"];var v=function(){function e(t,n){u(this,e),this.name=t,this._collections={},this._options=n}return c(e,[{key:"collection",value:function(t,n){if("string"!=typeof t)throw new Error('The collection name must be a "string", not "'+(void 0===t?"undefined":s(t))+'".');if(e._RESERVED.forEach(function(e){if(t===e)throw new Error("Collection name '"+t+"' is an internal reserved name and cannot be used.")}),t in this._collections)throw new Error("A collection with name '"+t+"' already exists on database '"+this.name+"'.");var i=o(this,t,n);return this._collections[t]=i,i}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The collection name must be a "string", "not a "'+(void 0===e?"undefined":s(e))+'".');if(e in this._collections)return this._collections[e];throw new Error("Collection name '"+e+"' has not been created and does not exist on database '"+this.name+"'.")}},{key:"list",value:function(){return Object.keys(this._collections)}}]),e}();v._RESERVED=["_RESERVED","name","_collections","_options","collection","get","list"];var _=function(){function e(){u(this,e),this.Database=v,this.Collection=y,this.Query=d,this._databases={}}return c(e,[{key:"create",value:function(t){if("string"!=typeof t)throw new Error('The database name must be a "string", not "'+(void 0===t?"undefined":s(t))+'".');if(e._RESERVED.forEach(function(e){if(t===e)throw new Error("Database name '"+t+"' is an internal reserved name and cannot be used.")}),t in this._databases)throw new Error("A database with name '"+t+"' already exists.");var n=a(t);return this._databases[t]=n,n}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":s(e))+'".');if(e in this._databases)return this._databases[e];throw new Error("Database name '"+e+"' has not been created and does not exist.")}},{key:"list",value:function(){return Object.keys(this._databases)}},{key:"reset",value:function(e){if(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":s(e))+'".');if(!(e in this._databases))throw new Error("Database name '"+e+"' does not exist and cannot be reset.");delete this._databases[e]}else this._databases={}}}]),e}();return _._RESERVED=["Database","Collection","Query","_RESERVED","_databases","create","get","list","reset"],new Proxy(new _,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.")}})}();
