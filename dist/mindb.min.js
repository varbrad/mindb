var mindb=function(){"use strict";function e(e,t){t=t.replace(/\[(\w+)\]/g,".$1"),t=t.replace(/^\./,"");var n=t.split("."),r=e;return n.forEach(function(e){if(!r.hasOwnProperty(e))throw new Error("Nested property '"+t+"' could not be resolved at '"+e+"' property.");r=r[e]}),r}function t(e,t,n){var r=new u(e,t,n);return new Proxy(r,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Collection.")}})}function n(e,t){var n=new c(e,t);return new Proxy(n,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.Database.")}})}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=require("clone"),s=function(){function t(e,n){i(this,t),this._collection=e,this._data=n||{}}return o(t,[{key:"byId",value:function(e){var n=a(this._data,!1);return n.byId=e,new t(this._collection,n)}},{key:"eq",value:function(e){return this.op("===",e)}},{key:"exec",value:function(){var t=this._data,n=void 0;return t.byId?n=[this._collection.get(t.byId)]:(n=this._collection.values(),t.filters&&t.filters.forEach(function(e){n=n.filter(e)}),t.wheres&&t.wheres.forEach(function(e){n=n.filter(function(t){switch(e.op){case">":return t[e.key]>e.value;case"<":return t[e.key]<e.value;case">=":return t[e.key]>=e.value;case"<=":return t[e.key]<=e.value;case"===":return t[e.key]===e.value;case"!==":return t[e.key]!==e.value}})}),t.sort&&n.sort(function(n,r){var i=0;return t.sort.every(function(t){var o=t.nested?e(n,t.key):n[t.key],a=t.nested?e(r,t.key):r[t.key];return o===a||(i="number"==typeof o&&"number"==typeof a?(o-a)*t.order:(o>a?1:-1)*t.order,!1)}),i}),(t.limit||t.offset)&&(n=n.slice(t.offset||0,(t.offset||0)+(t.limit||n.length)))),t.select&&(n=n.map(function(e){var n={_id:e._id};return t.select.forEach(function(t){return n[t]=e[t]}),n})),1===t.limit||t.byId?n[0]:n}},{key:"exists",value:function(){return this.op("!==",void 0)}},{key:"filter",value:function(e){var n=a(this._data,!1);return n.filters=n.filters||[],n.filters.push(e),new t(this._collection,n)}},{key:"gt",value:function(e){return this.op(">",e)}},{key:"gte",value:function(e){return this.op(">=",e)}},{key:"is",value:function(e){return this.eq(e)}},{key:"limit",value:function(e){var n=a(this._data,!1);return n.limit=e,new t(this._collection,n)}},{key:"lt",value:function(e){return this.op("<",e)}},{key:"lte",value:function(e){return this.op("<=",e)}},{key:"ne",value:function(e){return this.op("!==",e)}},{key:"neg",value:function(){return this.op("<",0)}},{key:"negative",value:function(){return this.neg()}},{key:"not",value:function(e){return this.ne(e)}},{key:"offset",value:function(e){var n=a(this._data,!1);return n.offset=e,new t(this._collection,n)}},{key:"one",value:function(){return this.limit(1)}},{key:"op",value:function(e,n){var r=a(this._data,!1);return r.wheres=r.wheres||[],r.wheres.push({key:r.key,value:n,op:e}),new t(this._collection,r)}},{key:"populate",value:function(){if(!this._collection.schema)throw new Error("Cannot populate document without a defined schema for '"+this._collection.schema+"'.");for(var e=a(this._data,!1),n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return e.populate=r,new t(this._collection,e)}},{key:"pos",value:function(){return this.op(">",0)}},{key:"positive",value:function(){return this.pos()}},{key:"select",value:function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];if(-1!==n.indexOf("_id"))throw new Error("Document id is always included in the Document, no need to explicity select it.");if(!n.every(function(e){return"string"==typeof e}))throw new Error('All select keys must be of type "string".');var i=a(this._data,!1);return i.select=n,new t(this._collection,i)}},{key:"sort",value:function(){var e=a(this._data,!1);e.sort=[];for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return r.forEach(function(t){var n="-"===t[0]?-1:1,r=!!t.match(/(\[|\]|\.)/g);e.sort.push({key:t.replace(/(\-|\+)/g,""),order:n,nested:r})}),new t(this._collection,e)}},{key:"within",value:function(e,t){return this.op(">=",e).op("<=",t)}},{key:"where",value:function(e){var n=a(this._data,!1);return n.action="where",n.key=e,new t(this._collection,n)}}]),t}(),u=function(){function e(t,n,r){i(this,e),this._database=t,this.name=n,this.schema=r,this._documents={}}return o(e,[{key:"empty",value:function(){this._documents={}}},{key:"find",value:function(){return new s(this)}},{key:"findOne",value:function(e){if(e&&"string"!=typeof e)throw new Error('The document is must be a "string", not a "'+(void 0===e?"undefined":r(e))+'".');return e?this.find().byId(e):this.find().limit(1)}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The document id must be a "string", not a "'+("undefined"==typeof name?"undefined":r(name))+'".');if(e in this._documents)return this._documents[e]}},{key:"insert",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t._id)throw new Error("The document to be inserted has no '_id'.");if("string"!=typeof t._id)throw new Error('A document must have a "string" _id, not a "'+("undefined"==typeof name?"undefined":r(name))+'".');if(e._RESERVED.forEach(function(e){if(t._id===e)throw new Error("The document _id '"+t._id+"' is an internal reserved name and cannot be used.")}),!n&&t._id in this._documents)throw new Error("The document _id '"+t._id+"' already exists within the '"+this.name+"' collection.");return this._documents[t._id]=t,t}},{key:"list",value:function(){return Object.keys(this._documents)}},{key:"remove",value:function(e){var t=this;if(!e)throw new Error("No argument provided to remove from collection.");if("string"==typeof e)delete this._documents[e];else if(e instanceof Array)e.forEach(function(e){t.remove(e._id)});else{if("object"!==(void 0===e?"undefined":r(e)))throw new Error('Incorrect argument provided to remove, must be either "string", "Document" or "Document[]", not "'+(void 0===e?"undefined":r(e))+'".');this.remove(e._id)}}},{key:"upsert",value:function(e){return this.insert(e,!0)}},{key:"values",value:function(){var e=this;return Object.keys(this._documents).map(function(t){return e._documents[t]})}}]),e}();u._RESERVED=["_RESERVED","name","schema","_database","_documents","get","insert","list","upsert","values"];var c=function(){function e(t,n){i(this,e),this.name=t,this._collections={},this._options=n}return o(e,[{key:"collection",value:function(n,i){if("string"!=typeof n)throw new Error('The collection name must be a "string", not "'+(void 0===n?"undefined":r(n))+'".');if(e._RESERVED.forEach(function(e){if(n===e)throw new Error("Collection name '"+n+"' is an internal reserved name and cannot be used.")}),n in this._collections)throw new Error("A collection with name '"+n+"' already exists on database '"+this.name+"'.");var o=t(this,n,i);return this._collections[n]=o,o}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The collection name must be a "string", "not a "'+(void 0===e?"undefined":r(e))+'".');if(e in this._collections)return this._collections[e];throw new Error("Collection name '"+e+"' has not been created and does not exist on database '"+this.name+"'.")}},{key:"list",value:function(){return Object.keys(this._collections)}}]),e}();c._RESERVED=["_RESERVED","name","_collections","_options","collection","get","list"];var l=function(){function e(){i(this,e),this.Database=c,this.Collection=u,this.Query=s,this._databases={}}return o(e,[{key:"create",value:function(t){if("string"!=typeof t)throw new Error('The database name must be a "string", not "'+(void 0===t?"undefined":r(t))+'".');if(e._RESERVED.forEach(function(e){if(t===e)throw new Error("Database name '"+t+"' is an internal reserved name and cannot be used.")}),t in this._databases)throw new Error("A database with name '"+t+"' already exists.");var i=n(t);return this._databases[t]=i,i}},{key:"get",value:function(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":r(e))+'".');if(e in this._databases)return this._databases[e];throw new Error("Database name '"+e+"' has not been created and does not exist.")}},{key:"list",value:function(){return Object.keys(this._databases)}},{key:"reset",value:function(e){if(e){if("string"!=typeof e)throw new Error('The database name must be a "string", not a "'+(void 0===e?"undefined":r(e))+'".');if(!(e in this._databases))throw new Error("Database name '"+e+"' does not exist and cannot be reset.");delete this._databases[e]}else this._databases={}}}]),e}();return l._RESERVED=["Database","Collection","Query","_RESERVED","_databases","create","get","list","reset"],new Proxy(new l,{get:function(e,t){return t in e?e[t]:"string"==typeof t&&-1!==e.list().indexOf(t)?e.get(t):void 0},set:function(e,t,n){if(t in e)return e[t]=n,!0;throw new Error("Do not dynamically set values on MinDB.")}})}();
